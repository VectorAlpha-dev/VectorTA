---
import DocsLayout from '../../layouts/DocsLayout.astro';
import { indicators } from '../../data/indicator-registry';
import { CategoryIcon } from '../../components/ui/CategoryIcon';
import { IndicatorGrid } from '../../components/ui/IndicatorGrid';

// Group indicators by category with proper descriptions
const categoryDescriptions: Record<string, string> = {
  'momentum': 'Measure the rate of price change and identify overbought/oversold conditions',
  'trend': 'Identify and follow market trends and their strength',
  'volatility': 'Measure market volatility and price ranges',
  'volume': 'Analyze trading volume and its relationship with price',
  'moving_averages': 'Smooth price data to identify trends and support/resistance levels',
  'statistical': 'Apply statistical analysis to price data',
  'support_resistance': 'Identify key price levels and stops',
  'price': 'Transform and analyze price data',
  'cycles': 'Identify market cycles and periodic patterns',
  'other': 'Specialized indicators and unique analysis tools'
};

// Group indicators by category
const categorizedIndicators = Object.entries(indicators).reduce((acc, [id, indicator]) => {
  const category = indicator.category || 'other';
  if (!acc[category]) acc[category] = [];
  acc[category].push({ ...indicator, id });
  return acc;
}, {} as Record<string, any[]>);

// Sort categories by importance and indicators within each category
const categoryOrder = ['momentum', 'trend', 'volatility', 'volume', 'moving_averages', 'statistical', 'support_resistance', 'price', 'cycles', 'other'];
const sortedCategories = categoryOrder
  .filter(cat => categorizedIndicators[cat])
  .map(category => ({
    name: category,
    description: categoryDescriptions[category] || '',
    indicators: categorizedIndicators[category].sort((a, b) => a.name.localeCompare(b.name))
  }));

// Add any remaining categories not in the order
Object.keys(categorizedIndicators).forEach(cat => {
  if (!categoryOrder.includes(cat)) {
    sortedCategories.push({
      name: cat,
      description: categoryDescriptions[cat] || '',
      indicators: categorizedIndicators[cat].sort((a, b) => a.name.localeCompare(b.name))
    });
  }
});

const totalIndicators = Object.keys(indicators).length;
const targetIndicators = 300; // Target number of indicators
const implementedIndicators = totalIndicators; // All indicators in registry are implemented
---

<DocsLayout 
  title="Technical Indicators Reference" 
  description="Comprehensive reference for all technical analysis indicators in VectorTA. Browse by category or search for specific indicators."
>
  <div class="content-container">
    <!-- Header -->
    <header class="mb-8 text-center">
      <h1 class="gradient-text mb-4">Technical Indicators Reference</h1>
      <p class="text-lg text-muted-foreground max-w-3xl mx-auto">
        Explore our comprehensive collection of {totalIndicators} technical analysis indicators. 
        Each indicator includes detailed documentation, parameter explanations, and practical examples.
      </p>
      <div class="flex justify-center gap-6 mt-6">
        <div class="text-center">
          <p class="text-2xl font-bold text-primary">{implementedIndicators}</p>
          <p class="text-sm text-muted-foreground">Implemented</p>
        </div>
        <div class="text-center">
          <p class="text-2xl font-bold text-muted-foreground">{targetIndicators - implementedIndicators}</p>
          <p class="text-sm text-muted-foreground">Coming Soon</p>
        </div>
      </div>
    </header>

    <!-- Advanced Filter and Grid -->
    <div id="advanced-view" class="hidden">
      <IndicatorGrid client:load indicators={indicators} />
    </div>

    <!-- Toggle between views -->
    <div class="text-center mb-8">
      <button 
        id="toggle-view"
        class="px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors"
      >
        Switch to Advanced View
      </button>
    </div>

    <!-- Search Bar -->
    <div id="simple-view">
      <div class="mb-8">
        <div class="max-w-2xl mx-auto">
          <div class="relative">
          <input
            type="text"
            id="indicator-search"
            placeholder="Search indicators by name, category, or keyword..."
            class="w-full px-4 py-3 pl-12 bg-muted rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
          />
          <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <p class="text-sm text-muted-foreground mt-2 text-center">
          Try searching for "momentum", "RSI", or "moving average"
        </p>
        </div>
      </div>
    
      <!-- Quick Links -->
    <div class="mb-12">
      <div class="flex flex-wrap justify-center gap-2">
        {sortedCategories.map(({ name }) => (
          <a 
            href={`#${name}`}
            class="px-4 py-2 bg-muted hover:bg-muted/80 rounded-lg text-sm transition-colors capitalize"
          >
            {name.replace(/_/g, ' ')}
          </a>
        ))}
      </div>
    </div>
    </div>

    <!-- Categories -->
    <div id="categories-container" class="space-y-6">
      {sortedCategories.map(({ name, description, indicators: categoryIndicators }) => (
        <section id={name} class="scroll-mt-20 category-section">
          <button
            class="w-full text-left mb-4 p-4 bg-muted rounded-lg hover:bg-muted/80 transition-colors category-toggle"
            data-category={name}
            aria-expanded="false"
            aria-controls={`category-${name}`}
          >
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <svg class="w-5 h-5 transition-transform category-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
                <CategoryIcon category={name} className="w-6 h-6 text-primary" client:load />
                <h2 class="text-lg font-bold capitalize">
                  {name.replace(/_/g, ' ')}
                </h2>
                <span class="text-sm font-normal text-muted-foreground">({categoryIndicators.length})</span>
              </div>
              <span class="text-sm text-muted-foreground hidden sm:block">
                Click to expand
              </span>
            </div>
            {description && (
              <p class="text-muted-foreground mt-2 ml-14">{description}</p>
            )}
          </button>
          
          <div id={`category-${name}`} class="category-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pl-14">
              {categoryIndicators.map((indicator) => (
                <a
                  href={`${import.meta.env.BASE_URL}indicators/${indicator.id}`}
                  class="card hover:shadow-lg transition-all group indicator-card"
                  data-indicator={JSON.stringify({ id: indicator.id, name: indicator.name, category: name })}
                >
                  <h3 class="font-semibold mb-2 group-hover:text-primary transition-colors">
                    {indicator.name}
                  </h3>
                  <p class="text-sm text-muted-foreground mb-3 line-clamp-2">
                    {indicator.description || `Calculate ${indicator.name} for technical analysis`}
                  </p>
                  <div class="flex items-center justify-between text-xs text-muted-foreground">
                    <span class="font-mono">{indicator.id}</span>
                    <span class="flex items-center gap-1">
                      {indicator.parameters?.length || 0} params
                      <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                      </svg>
                    </span>
                  </div>
                </a>
              ))}
            </div>
          </div>
        </section>
      ))}
    </div>

    <!-- Getting Started Section -->
    <section class="mt-12 py-8 border-t border-border">
      <h2 class="text-xl font-bold mb-6 text-center">Getting Started</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
        <div class="text-center">
          <div class="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center mx-auto mb-4">
            <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
          </div>
          <h3 class="font-semibold mb-2">Read the Docs</h3>
          <p class="text-sm text-muted-foreground">
            Each indicator has comprehensive documentation with examples and use cases
          </p>
        </div>
        
        <div class="text-center">
          <div class="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center mx-auto mb-4">
            <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
          </div>
          <h3 class="font-semibold mb-2">Interactive Charts</h3>
          <p class="text-sm text-muted-foreground">
            Visualize indicators with real-time parameter adjustments
          </p>
        </div>
        
        <div class="text-center">
          <div class="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center mx-auto mb-4">
            <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
            </svg>
          </div>
          <h3 class="font-semibold mb-2">Copy & Use</h3>
          <p class="text-sm text-muted-foreground">
            Example code for every indicator ready to copy and integrate
          </p>
        </div>
      </div>
    </section>
  </div>

  <script>
    // View toggle functionality
    const toggleBtn = document.getElementById('toggle-view') as HTMLButtonElement;
    const simpleView = document.getElementById('simple-view');
    const categoriesContainer = document.getElementById('categories-container');
    const advancedView = document.getElementById('advanced-view');
    let isAdvancedView = false;

    toggleBtn?.addEventListener('click', () => {
      isAdvancedView = !isAdvancedView;
      
      if (isAdvancedView) {
        simpleView?.classList.add('hidden');
        categoriesContainer?.classList.add('hidden');
        advancedView?.classList.remove('hidden');
        toggleBtn.textContent = 'Switch to Simple View';
      } else {
        simpleView?.classList.remove('hidden');
        categoriesContainer?.classList.remove('hidden');
        advancedView?.classList.add('hidden');
        toggleBtn.textContent = 'Switch to Advanced View';
      }
    });

    // Category collapse/expand functionality
    const categoryToggles = document.querySelectorAll('.category-toggle') as NodeListOf<HTMLButtonElement>;
    const categoryContents = document.querySelectorAll('.category-content') as NodeListOf<HTMLElement>;
    
    categoryToggles.forEach(toggle => {
      toggle.addEventListener('click', () => {
        const category = toggle.dataset.category;
        const content = document.getElementById(`category-${category}`);
        const chevron = toggle.querySelector('.category-chevron');
        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
        
        if (content) {
          if (isExpanded) {
            // Collapse
            content.classList.add('hidden');
            toggle.setAttribute('aria-expanded', 'false');
            chevron?.classList.remove('rotate-90');
            toggle.querySelector('.hidden.sm\\:block')!.textContent = 'Click to expand';
          } else {
            // Expand
            content.classList.remove('hidden');
            toggle.setAttribute('aria-expanded', 'true');
            chevron?.classList.add('rotate-90');
            toggle.querySelector('.hidden.sm\\:block')!.textContent = 'Click to collapse';
          }
        }
      });
    });

    // Search functionality
    const searchInput = document.getElementById('indicator-search') as HTMLInputElement;
    const indicatorCards = document.querySelectorAll('.indicator-card') as NodeListOf<HTMLElement>;
    const categorySections = document.querySelectorAll('.category-section') as NodeListOf<HTMLElement>;

    searchInput?.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.toLowerCase();
      
      if (!query) {
        // Reset to collapsed state
        indicatorCards.forEach(card => card.style.display = '');
        categorySections.forEach(section => section.style.display = '');
        categoryContents.forEach(content => content.classList.add('hidden'));
        categoryToggles.forEach(toggle => {
          toggle.setAttribute('aria-expanded', 'false');
          toggle.querySelector('.category-chevron')?.classList.remove('rotate-90');
          toggle.querySelector('.hidden.sm\\:block')!.textContent = 'Click to expand';
        });
        return;
      }

      // Track which categories have visible indicators
      const visibleCategories = new Set<string>();

      // Filter indicators
      indicatorCards.forEach(card => {
        const data = JSON.parse(card.dataset.indicator || '{}');
        const matches = 
          data.name?.toLowerCase().includes(query) ||
          data.id?.toLowerCase().includes(query) ||
          data.category?.toLowerCase().includes(query);
        
        card.style.display = matches ? '' : 'none';
        
        if (matches && data.category) {
          visibleCategories.add(data.category);
        }
      });

      // Show/hide categories and auto-expand those with matches
      categorySections.forEach(section => {
        const categoryName = section.id;
        if (categoryName && visibleCategories.has(categoryName)) {
          section.style.display = '';
          // Auto-expand categories with matches
          const content = document.getElementById(`category-${categoryName}`);
          const toggle = section.querySelector('.category-toggle');
          const chevron = toggle?.querySelector('.category-chevron');
          if (content && toggle) {
            content.classList.remove('hidden');
            toggle.setAttribute('aria-expanded', 'true');
            chevron?.classList.add('rotate-90');
            const expandText = toggle.querySelector('.hidden.sm\\:block');
            if (expandText) expandText.textContent = 'Click to collapse';
          }
        } else {
          section.style.display = 'none';
        }
      });
    });

    // Smooth scroll for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const href = anchor.getAttribute('href');
        if (href) {
          const target = document.querySelector(href);
          if (target) {
            // Expand the category if it's collapsed
            const section = target.closest('.category-section');
            if (section) {
              const toggle = section.querySelector('.category-toggle') as HTMLButtonElement;
              const content = section.querySelector('.category-content');
              const chevron = toggle?.querySelector('.category-chevron');
              if (content && toggle && content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                toggle.setAttribute('aria-expanded', 'true');
                chevron?.classList.add('rotate-90');
                const expandText = toggle.querySelector('.hidden.sm\\:block');
                if (expandText) expandText.textContent = 'Click to collapse';
              }
            }
            
            target.scrollIntoView({
              behavior: 'smooth',
              block: 'start'
            });
          }
        }
      });
    });

    // Expand category if linked directly
    const hash = window.location.hash.slice(1);
    if (hash) {
      const section = document.getElementById(hash);
      if (section) {
        const toggle = section.querySelector('.category-toggle') as HTMLButtonElement;
        const content = section.querySelector('.category-content');
        const chevron = toggle?.querySelector('.category-chevron');
        if (content && toggle) {
          content.classList.remove('hidden');
          toggle.setAttribute('aria-expanded', 'true');
          chevron?.classList.add('rotate-90');
          const expandText = toggle.querySelector('.hidden.sm\\:block');
          if (expandText) expandText.textContent = 'Click to collapse';
        }
      }
    }
  </script>
  <style>
    .category-chevron {
      transition: transform 0.2s ease-in-out;
    }
    
    .category-content {
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</DocsLayout>
