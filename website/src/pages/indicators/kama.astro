---
import IndicatorLayout from '../../layouts/IndicatorLayout.astro';

const indicatorId = 'kama';
const indicatorName = 'Kaufman Adaptive Moving Average';
const description = `The Kaufman Adaptive Moving Average (KAMA) is an intelligent moving average that automatically adjusts its speed based on market volatility and trend strength, becoming faster during trends and slower during consolidations to reduce whipsaws.`;
const parameters = [
  {
    "name": "period",
    "type": "number",
    "default": 10,
    "min": 2,
    "max": 200,
    "description": "Efficiency Ratio calculation period"
  },
  {
    "name": "fast_period",
    "type": "number",
    "default": 2,
    "min": 2,
    "max": 50,
    "description": "Fast EMA period for trending markets"
  },
  {
    "name": "slow_period",
    "type": "number",
    "default": 30,
    "min": 10,
    "max": 200,
    "description": "Slow EMA period for ranging markets"
  }
];
---

<IndicatorLayout
  indicatorId={indicatorId}
  indicatorName={indicatorName}
  description={description}
  parameters={parameters}
>
  <h2 id="overview">Overview</h2>
  <p>
    The Kaufman Adaptive Moving Average (KAMA), developed by Perry Kaufman, is a sophisticated 
    trend-following indicator that solves the age-old problem of choosing between responsive and 
    smooth moving averages. KAMA automatically adjusts its sensitivity based on the Efficiency 
    Ratio (ER), which measures the directional movement versus total volatility.
  </p>
  <p>
    During strong trends, KAMA behaves like a fast moving average, staying close to price and 
    providing timely signals. During sideways markets, it acts like a slow moving average, 
    filtering out market noise and reducing false signals. This adaptive behavior makes KAMA 
    particularly effective for trend-following systems that need to work across different market 
    conditions without constant parameter adjustment.
  </p>

  <h2 id="interpretation">Interpretation</h2>
  <h3>Adaptive Behavior</h3>
  <ul>
    <li><strong>Trending markets:</strong> KAMA moves closer to price, similar to fast EMA</li>
    <li><strong>Ranging markets:</strong> KAMA becomes smoother, similar to slow EMA</li>
    <li><strong>Efficiency Ratio:</strong> High ER (near 1) = strong trend, Low ER (near 0) = choppy market</li>
    <li><strong>Noise filtering:</strong> Automatically reduces sensitivity in noisy conditions</li>
  </ul>

  <h3>Trading Signals</h3>
  <ul>
    <li><strong>Trend direction:</strong> Rising KAMA = uptrend, Falling KAMA = downtrend</li>
    <li><strong>Price crossovers:</strong> Price crossing KAMA generates entry/exit signals</li>
    <li><strong>KAMA turns:</strong> Changes in KAMA direction signal potential reversals</li>
    <li><strong>Support/Resistance:</strong> KAMA acts as dynamic support in uptrends</li>
  </ul>

  <h3>Advantages</h3>
  <ul>
    <li><strong>Self-adjusting:</strong> No need to manually switch between fast/slow settings</li>
    <li><strong>Reduced whipsaws:</strong> Fewer false signals in ranging markets</li>
    <li><strong>Trend preservation:</strong> Stays with trends longer than fixed MAs</li>
    <li><strong>Versatility:</strong> Works across different markets and timeframes</li>
  </ul>

  <h2 id="calculation">Calculation</h2>
  <p>KAMA calculation involves three main steps:</p>
  <ol>
    <li><strong>Calculate Efficiency Ratio (ER):</strong>
      <ul>
        <li>Direction = abs(Close - Close[n periods ago])</li>
        <li>Volatility = Sum of abs(Close - Close[1]) over n periods</li>
        <li>ER = Direction / Volatility</li>
      </ul>
    </li>
    <li><strong>Calculate Smoothing Constant (SC):</strong>
      <ul>
        <li>FastSC = 2 / (fast_period + 1)</li>
        <li>SlowSC = 2 / (slow_period + 1)</li>
        <li>SC = [ER × (FastSC - SlowSC) + SlowSC]²</li>
      </ul>
    </li>
    <li><strong>Calculate KAMA:</strong>
      <ul>
        <li>KAMA = KAMA[1] + SC × (Price - KAMA[1])</li>
      </ul>
    </li>
  </ol>
  <p>
    The squaring of SC in step 2 provides a more gradual transition between fast and slow speeds, 
    preventing abrupt changes in KAMA's behavior. This creates the smooth, adaptive response that 
    makes KAMA so effective.
  </p>

  <h2 id="parameters">Parameters</h2>
  <ul>
    <li>
      <strong>Period (default: 10):</strong> The lookback period for calculating the Efficiency 
      Ratio. This determines how many bars are used to measure trend efficiency. Common values 
      range from 8-21. Shorter periods make KAMA more reactive to recent changes, while longer 
      periods provide more stable efficiency measurements.
    </li>
    <li>
      <strong>Fast Period (default: 2):</strong> The EMA equivalent period used when the market 
      is trending strongly (ER = 1). This represents the fastest KAMA can move. The traditional 
      value is 2, making KAMA very responsive during strong trends. Values of 3-5 reduce noise 
      while maintaining responsiveness.
    </li>
    <li>
      <strong>Slow Period (default: 30):</strong> The EMA equivalent period used when the market 
      is completely random (ER = 0). This represents the slowest KAMA can move. The traditional 
      value is 30, providing significant smoothing in choppy markets. Values of 20-50 are common, 
      with higher values providing more noise reduction.
    </li>
  </ul>

  <h2 id="returns">Returns & Output</h2>
  <p>The indicator returns an array of KAMA values:</p>
  <ul>
    <li><strong>Type:</strong> Array of floating-point numbers</li>
    <li><strong>Length:</strong> Same as input array</li>
    <li><strong>Initial values:</strong> First 'period' values may be less stable</li>
    <li><strong>Characteristics:</strong> Adaptive smoothing between fast and slow speeds</li>
    <li><strong>Range:</strong> Follows price range, no fixed bounds</li>
  </ul>

  <h2 id="usage">Example Usage</h2>
  <h3>Rust Implementation</h3>
  <pre><code class="language-rust">
use ta_lib::indicators::kama;

// Calculate KAMA with default parameters
let prices = vec![100.0, 102.0, 101.5, 103.0, 102.5, 104.0, 105.5, 104.5, 106.0, 107.0];
let kama_values = kama(&prices, 10, 2, 30)?;

// Manual ER calculation for understanding
fn calculate_efficiency_ratio(prices: &[f64], period: usize) -> Vec<f64> {
    let mut er_values = vec![0.0; prices.len()];
    
    for i in period..prices.len() {
        // Direction (net change)
        let direction = (prices[i] - prices[i - period]).abs();
        
        // Volatility (sum of absolute changes)
        let mut volatility = 0.0;
        for j in (i - period + 1)..=i {
            volatility += (prices[j] - prices[j - 1]).abs();
        }
        
        // Efficiency Ratio
        er_values[i] = if volatility != 0.0 {
            direction / volatility
        } else {
            0.0
        };
        
        println!("Bar {}: Price={:.2}, ER={:.3}", i, prices[i], er_values[i]);
    }
    er_values
}

// Trading signals
for i in 1..kama_values.len() {
    if let (Some(current), Some(previous)) = (kama_values[i], kama_values[i-1]) {
        // Trend detection
        let kama_rising = current > previous;
        let kama_change_pct = (current - previous) / previous * 100.0;
        
        // Price position
        if prices[i] > current && prices[i-1] <= previous {
            println!("Bullish crossover at {}: Price crossed above KAMA", i);
        }
        
        // KAMA acceleration
        if i > 1 {
            if let Some(prev_prev) = kama_values[i-2] {
                let accel = (current - previous) - (previous - prev_prev);
                if accel > 0.0 && kama_rising {
                    println!("KAMA accelerating upward at {}", i);
                }
            }
        }
    }
}

// Compare with fixed MAs
let ema_10 = ema(&prices, 10)?;
let ema_30 = ema(&prices, 30)?;

for i in 0..prices.len() {
    if let (Some(k), Some(f), Some(s)) = (kama_values[i], ema_10[i], ema_30[i]) {
        println!("Index {}: KAMA={:.2}, EMA10={:.2}, EMA30={:.2}", i, k, f, s);
    }
}
  </code></pre>

  <h3>Python Integration</h3>
  <pre><code class="language-python">
import pandas as pd
import numpy as np
from ta_lib import kama

# Example usage with price data
df = pd.DataFrame({
    'close': [100, 102, 101.5, 103, 102.5, 104, 105.5, 104.5, 106, 107, 106.5, 108, 109, 108.5, 110]
})

# Calculate KAMA with different parameters
df['kama_default'] = kama(df['close'], period=10, fast_period=2, slow_period=30)
df['kama_responsive'] = kama(df['close'], period=8, fast_period=2, slow_period=20)
df['kama_smooth'] = kama(df['close'], period=14, fast_period=3, slow_period=40)

# Trading signals
df['kama_trend'] = np.where(df['kama_default'] > df['kama_default'].shift(1), 1, -1)
df['price_above_kama'] = df['close'] > df['kama_default']

# Crossover signals
df['bullish_cross'] = df['price_above_kama'] & ~df['price_above_kama'].shift(1)
df['bearish_cross'] = ~df['price_above_kama'] & df['price_above_kama'].shift(1)

# KAMA slope for trend strength
df['kama_slope'] = df['kama_default'].diff()
df['kama_slope_pct'] = df['kama_default'].pct_change() * 100

# Acceleration
df['kama_acceleration'] = df['kama_slope'].diff()
df['trend_strengthening'] = (df['kama_trend'] == 1) & (df['kama_acceleration'] > 0)

# Calculate Efficiency Ratio manually
def efficiency_ratio(close, period=10):
    direction = abs(close - close.shift(period))
    volatility = abs(close.diff()).rolling(period).sum()
    return direction / volatility

df['er'] = efficiency_ratio(df['close'])
df['trending'] = df['er'] > 0.3  # Market is trending when ER > 0.3

# Adaptive stop loss
df['kama_atr'] = atr(df['high'], df['low'], df['close'], 14)
df['stop_long'] = df['kama_default'] - df['kama_atr'] * np.where(df['er'] > 0.5, 1.5, 2.5)
df['stop_short'] = df['kama_default'] + df['kama_atr'] * np.where(df['er'] > 0.5, 1.5, 2.5)

print(df[['close', 'kama_default', 'er', 'kama_trend', 'bullish_cross']].tail(10))
  </code></pre>

  <h2 id="use-cases">Common Use Cases</h2>
  <h3>1. Adaptive Trend Following</h3>
  <p>Using KAMA for trend identification and entry:</p>
  <pre><code class="language-python">
# Calculate KAMA
kama_line = kama(close, 10, 2, 30)

# Trend filters
kama_rising = kama_line > kama_line.shift(1)
kama_falling = kama_line < kama_line.shift(1)

# Slope threshold for trend strength
min_slope = 0.1  # 0.1% minimum slope
kama_slope_pct = kama_line.pct_change() * 100
strong_uptrend = kama_rising & (kama_slope_pct > min_slope)
strong_downtrend = kama_falling & (kama_slope_pct < -min_slope)

# Entry signals
buy_signal = (close > kama_line) & strong_uptrend & (close.shift(1) <= kama_line.shift(1))
sell_signal = (close < kama_line) & strong_downtrend & (close.shift(1) >= kama_line.shift(1))

# Exit on KAMA flattening
kama_flattening = abs(kama_slope_pct) < 0.05
exit_signal = kama_flattening | (df['er'] < 0.2)
  </code></pre>

  <h3>2. KAMA Band Trading</h3>
  <p>Creating adaptive bands around KAMA:</p>
  <pre><code class="language-python">
# Calculate KAMA and ER
kama_center = kama(close, 10, 2, 30)
er = efficiency_ratio(close, 10)

# Adaptive band width based on ER
atr_value = atr(high, low, close, 14)
band_multiplier = np.where(er > 0.5, 1.5,  # Tight bands in trends
                          np.where(er > 0.3, 2.0,  # Medium bands
                                             2.5))  # Wide bands in ranges

upper_band = kama_center + atr_value * band_multiplier
lower_band = kama_center - atr_value * band_multiplier

# Mean reversion in low ER
low_er = er < 0.3
buy_reversal = low_er & (close <= lower_band) & (close > close.shift(1))
sell_reversal = low_er & (close >= upper_band) & (close < close.shift(1))

# Breakout in high ER
high_er = er > 0.5
buy_breakout = high_er & (close > upper_band) & (close.shift(1) <= upper_band.shift(1))
sell_breakout = high_er & (close < lower_band) & (close.shift(1) >= lower_band.shift(1))

# Combine strategies based on market condition
final_buy = buy_reversal | buy_breakout
final_sell = sell_reversal | sell_breakout
  </code></pre>

  <h3>3. Multi-KAMA System</h3>
  <p>Using multiple KAMA settings for confirmation:</p>
  <pre><code class="language-python">
# Calculate multiple KAMAs
kama_fast = kama(close, 8, 2, 20)    # More responsive
kama_medium = kama(close, 10, 2, 30)  # Balanced
kama_slow = kama(close, 14, 3, 40)   # More stable

# Trend alignment
all_rising = (kama_fast > kama_fast.shift(1)) & \
             (kama_medium > kama_medium.shift(1)) & \
             (kama_slow > kama_slow.shift(1))

all_falling = (kama_fast < kama_fast.shift(1)) & \
              (kama_medium < kama_medium.shift(1)) & \
              (kama_slow < kama_slow.shift(1))

# KAMA spread analysis
fast_medium_spread = (kama_fast - kama_medium) / kama_medium * 100
medium_slow_spread = (kama_medium - kama_slow) / kama_slow * 100

# Strong trend: KAMAs spreading apart
spreading = (abs(fast_medium_spread) > abs(fast_medium_spread.shift(5))) & \
            (abs(medium_slow_spread) > abs(medium_slow_spread.shift(5)))

# Consolidation: KAMAs converging
converging = (abs(fast_medium_spread) < abs(fast_medium_spread.shift(5))) & \
             (abs(medium_slow_spread) < abs(medium_slow_spread.shift(5)))

# Trading rules
strong_buy_setup = all_rising & spreading & (close > kama_fast)
strong_sell_setup = all_falling & spreading & (close < kama_fast)

# Exit on convergence
exit_longs = converging & (close < kama_medium)
exit_shorts = converging & (close > kama_medium)
  </code></pre>

  <h2 id="edge-cases">Edge Cases & Errors</h2>
  <h3>Common Issues</h3>
  <ul>
    <li><strong>Initialization period:</strong> Requires 'period' bars for stable ER calculation</li>
    <li><strong>Extreme ER values:</strong> Very high/low ER can cause abrupt KAMA changes</li>
    <li><strong>Parameter sensitivity:</strong> Fast period too low can increase noise</li>
    <li><strong>Whipsaws at ER transitions:</strong> When ER shifts between high and low</li>
  </ul>

  <h3>Best Practices</h3>
  <ul>
    <li>Use default parameters (10, 2, 30) as starting point</li>
    <li>Monitor ER values to understand KAMA behavior</li>
    <li>Combine with volume indicators for confirmation</li>
    <li>Use wider stops in low ER (choppy) conditions</li>
    <li>Consider KAMA slope for trend strength assessment</li>
    <li>Test parameter combinations for your specific market</li>
  </ul>

  <h2 id="references">References</h2>
  <ul>
    <li>Kaufman, P. J. (1995). <em>Smarter Trading</em>. McGraw-Hill.</li>
    <li>Kaufman, P. J. (2013). <em>Trading Systems and Methods</em>. 5th Edition. Wiley.</li>
    <li>Efficiency Ratio and adaptive filtering techniques</li>
    <li>Comparison studies: KAMA vs. other adaptive moving averages</li>
  </ul>
</IndicatorLayout>