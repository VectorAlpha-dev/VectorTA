---
import IndicatorLayout from '../../layouts/IndicatorLayout.astro';

const indicatorId = 'kaufmanstop';
const indicatorName = 'Kaufman Adaptive Stop';
const description = `The Kaufman Adaptive Stop is a dynamic stop-loss system that adjusts its distance from price based on market volatility and trend strength, providing tight stops in trends and wider stops in choppy markets to avoid premature exits.`;
const parameters = [
  {
    "name": "period",
    "type": "number",
    "default": 22,
    "min": 5,
    "max": 200,
    "description": "Lookback period for volatility calculation"
  },
  {
    "name": "multiplier",
    "type": "number",
    "default": 3.0,
    "min": 1.0,
    "max": 10.0,
    "description": "Stop distance multiplier"
  },
  {
    "name": "efficiency_period",
    "type": "number",
    "default": 10,
    "min": 2,
    "max": 50,
    "description": "Period for efficiency ratio calculation"
  }
];
---

<IndicatorLayout
  indicatorId={indicatorId}
  indicatorName={indicatorName}
  description={description}
  parameters={parameters}
>
  <h2 id="overview">Overview</h2>
  <p>
    The Kaufman Adaptive Stop is an advanced stop-loss management system developed by Perry Kaufman 
    that dynamically adjusts stop distances based on market conditions. Unlike fixed percentage or 
    point-based stops, this system adapts to both volatility and trend strength, providing optimal 
    protection without sacrificing profitable positions.
  </p>
  <p>
    The indicator combines the Efficiency Ratio (ER) concept with volatility measurement to create 
    stops that are tight during strong trends (when price movement is efficient) and wider during 
    choppy markets (when price movement is inefficient). This adaptive behavior significantly reduces 
    the problem of stops being hit by market noise while still providing protection against adverse 
    moves.
  </p>

  <h2 id="interpretation">Interpretation</h2>
  <h3>Stop Behavior</h3>
  <ul>
    <li><strong>Trending markets:</strong> Stops move closer to price for better profit protection</li>
    <li><strong>Choppy markets:</strong> Stops widen to avoid noise-induced exits</li>
    <li><strong>Long positions:</strong> Stop line below price, follows upward but never down</li>
    <li><strong>Short positions:</strong> Stop line above price, follows downward but never up</li>
  </ul>

  <h3>Trading Applications</h3>
  <ul>
    <li><strong>Stop placement:</strong> Use as actual stop-loss orders</li>
    <li><strong>Trailing stops:</strong> Automatically trails favorable price movement</li>
    <li><strong>Position sizing:</strong> Wider stops suggest smaller positions</li>
    <li><strong>Market regime:</strong> Stop distance indicates market condition</li>
  </ul>

  <h3>Key Features</h3>
  <ul>
    <li><strong>Adaptive distance:</strong> Adjusts based on efficiency and volatility</li>
    <li><strong>Ratchet effect:</strong> Only moves in favorable direction</li>
    <li><strong>Noise filtering:</strong> Reduces false stop-outs in ranging markets</li>
    <li><strong>Trend protection:</strong> Tightens during strong directional moves</li>
  </ul>

  <h2 id="calculation">Calculation</h2>
  <p>The Kaufman Adaptive Stop calculation process:</p>
  <ol>
    <li><strong>Calculate Efficiency Ratio (ER):</strong>
      <ul>
        <li>Direction = abs(Close - Close[n periods ago])</li>
        <li>Volatility = Sum of abs(Close - Close[1]) over n periods</li>
        <li>ER = Direction / Volatility (0 to 1)</li>
      </ul>
    </li>
    <li><strong>Calculate Adaptive Volatility:</strong>
      <ul>
        <li>True Range = max(High-Low, abs(High-Close[1]), abs(Low-Close[1]))</li>
        <li>ATR = Average True Range over period</li>
        <li>Adaptive Factor = 1 + (1 - ER) × (multiplier - 1)</li>
      </ul>
    </li>
    <li><strong>Calculate Stop Distance:</strong>
      <ul>
        <li>Base Distance = ATR × Adaptive Factor</li>
        <li>Stop Distance = Base Distance × multiplier</li>
      </ul>
    </li>
    <li><strong>Apply Ratchet Logic:</strong>
      <ul>
        <li>Long Stop = max(Previous Stop, Close - Stop Distance)</li>
        <li>Short Stop = min(Previous Stop, Close + Stop Distance)</li>
      </ul>
    </li>
  </ol>
  <p>
    The key innovation is using ER to modify the stop distance - when ER is high (trending), 
    the adaptive factor approaches 1 (tight stops). When ER is low (choppy), the adaptive 
    factor increases toward the multiplier value (wider stops).
  </p>

  <h2 id="parameters">Parameters</h2>
  <ul>
    <li>
      <strong>Period (default: 22):</strong> The number of bars used to calculate the Average 
      True Range (ATR) for volatility measurement. Longer periods create more stable stop 
      distances but may be slower to adapt to volatility changes. Common values range from 
      10-30, with 22 being approximately one trading month.
    </li>
    <li>
      <strong>Multiplier (default: 3.0):</strong> The base multiplier for stop distance. This 
      determines how many ATRs away the stop is placed in choppy markets. Higher values provide 
      more room but reduce profit protection. Values between 2-5 are common, with 3 providing 
      a good balance for most markets.
    </li>
    <li>
      <strong>Efficiency Period (default: 10):</strong> The period used to calculate the 
      Efficiency Ratio. This determines how responsive the stop is to changes in market 
      character. Shorter periods (5-10) make stops more adaptive, while longer periods (15-30) 
      provide more stable behavior.
    </li>
  </ul>

  <h2 id="returns">Returns & Output</h2>
  <p>The indicator returns stop levels for each position type:</p>
  <ul>
    <li><strong>Long Stop:</strong> Stop level for long positions (below price)</li>
    <li><strong>Short Stop:</strong> Stop level for short positions (above price)</li>
    <li><strong>Type:</strong> Two arrays of floating-point numbers</li>
    <li><strong>Ratchet behavior:</strong> Stops only move favorably, never adversely</li>
    <li><strong>Initial values:</strong> Requires warmup period for stable calculation</li>
  </ul>

  <h2 id="usage">Example Usage</h2>
  <h3>Rust Implementation</h3>
  <pre><code class="language-rust"> // Rust implementation example will be added here
</code></pre>

  <h3>Python Integration</h3> <pre><code class="language-python"> # Python implementation example will be added here
</code></pre>

  <h2 id="use-cases"> Common Use Cases</h2> <h3>1. Trend Following with Adaptive Stops</h3> <p>Complete trend following system with Kaufman stops:</p>
  <pre><code class="language-python"> # Python implementation example will be added here
</code></pre>

  <h3>2. Multi-Timeframe Stop System</h3> <p>Combining stops from different timeframes:</p>
  <pre><code class="language-python"> # Python implementation example will be added here
</code></pre>

  <h3>3. Volatility-Adjusted Trading</h3> <p>Using stop distance for market regime trading:</p>
  <pre><code class="language-python"> # Python implementation example will be added here
</code></pre>

  <h2 id="edge-cases"> Edge Cases & Errors</h2>
  <h3>Common Issues</h3>
  <ul>
    <li><strong>Initialization:</strong> Stops may be far from price initially</li>
    <li><strong>Gap risk:</strong> Large gaps can bypass stops entirely</li>
    <li><strong>Whipsaw markets:</strong> Rapid ER changes can cause stop instability</li>
    <li><strong>Parameter sensitivity:</strong> Multiplier heavily influences performance</li>
  </ul>

  <h3>Best Practices</h3>
  <ul>
    <li>Allow adequate warmup period before using stops</li>
    <li>Monitor actual vs expected stop hits for slippage</li>
    <li>Use limit orders near stops in thin markets</li>
    <li>Consider scaling out rather than full exit at stops</li>
    <li>Backtest different multipliers for your market</li>
    <li>Combine with profit targets for complete system</li>
  </ul>

  <h2 id="references">References</h2>
  <ul>
    <li>Kaufman, P. J. (1995). <em>Smarter Trading</em>. McGraw-Hill.</li>
    <li>Kaufman, P. J. (2013). <em>Trading Systems and Methods</em>. 5th Edition. Wiley.</li>
    <li>Adaptive stop-loss techniques and position sizing strategies</li>
    <li>Risk management in systematic trading</li>
  </ul>
</IndicatorLayout>
