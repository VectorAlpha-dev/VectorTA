---
import DocsLayout from './DocsLayout.astro';
import { IndicatorWithUpload } from '../components/charts/IndicatorWithUpload';
import RelatedIndicators from '../components/ui/RelatedIndicators.astro';
import { PerformanceChart } from '../components/performance/PerformanceChart';
import { CodeExport } from '../components/export/CodeExport';

export interface Props {
  indicatorId: string;
  indicatorName: string;
  description?: string;
  parameters: any[];
  category?: string;
}

const { indicatorId, indicatorName, description, parameters, category } = Astro.props;

// Get default parameters
const defaultParams = parameters.reduce((acc, p) => ({ 
  ...acc, 
  [p.name]: p.default 
}), {});

// Determine if this is an oscillator that needs a separate pane
const oscillatorIndicators = ['rsi', 'stoch', 'cci', 'williams_r', 'mfi', 'ultimate_oscillator', 'macd', 'atr'];
const isOscillator = oscillatorIndicators.includes(indicatorId) || category === 'oscillators' || category === 'momentum';
---

<DocsLayout title={indicatorName} description={description}>
  <div class="content-container">
    <header class="mb-8">
      <h1 class="gradient-text">{indicatorName}</h1>
    </header>
    
    <!-- Parameters Info at the top -->
    {parameters && parameters.length > 0 && (
      <div class="mb-6 p-4 bg-muted/50 rounded-lg border border-border">
        <div class="flex flex-wrap gap-4 items-center">
          <span class="text-sm font-medium">Parameters:</span>
          {parameters.map((param, index) => (
            <span class="text-sm">
              <code class="text-xs bg-background px-2 py-1 rounded">{param.name}</code>
              <span class="text-muted-foreground ml-1">= {param.default}</span>
              {param.min !== undefined && param.max !== undefined && (
                <span class="text-xs text-muted-foreground ml-1">({param.min}–{param.max})</span>
              )}
              {index < parameters.length - 1 && <span class="text-muted-foreground mx-2">•</span>}
            </span>
          ))}
        </div>
      </div>
    )}
    
    <div class="space-y-8">
        <!-- Chart Card -->
        <div class="card overflow-hidden" style="max-width: 100%;">
          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            Interactive Chart
          </h2>
          <div id="chart-container" class="animate-fade-in overflow-hidden" style="max-width: 100%;">
            <IndicatorWithUpload
              client:only="react"
              indicatorId={indicatorId}
              indicatorName={indicatorName}
              parameters={defaultParams}
              isOscillator={isOscillator}
              category={category}
            />
          </div>
        </div>
        
        <!-- Documentation Content -->
        <div class="prose prose-sm dark:prose-invert max-w-4xl mx-auto">
          <slot />
        </div>
        
        <!-- Performance Section -->
        <div class="mt-12 space-y-6">
          <h2 class="text-xl font-semibold mb-6 text-center">Performance Analysis</h2>
          
          <div class="card">
            <h3 class="text-base font-semibold mb-4">Performance Comparison</h3>
            <PerformanceChart client:load indicatorId={indicatorId} />
          </div>
          
        </div>
    </div>
  </div>
  <!-- Related Indicators -->
  <RelatedIndicators currentIndicator={indicatorId} />
</DocsLayout>

<style>
  /* Ensure proper spacing for content */
  .prose-content :global(h2) {
    @apply scroll-mt-20;
  }
  
  .prose-content :global(h3) {
    @apply scroll-mt-16;
  }
  
  /* Code block styling */
  .prose-content :global(.not-prose) {
    @apply my-6;
  }
  
  
  /* Smooth scroll for anchor links */
  html {
    scroll-behavior: smooth;
  }
</style>
