---
import Header from "../components/layout/Header.astro";
import Sidebar from "../components/layout/Sidebar.astro";
import Footer from "../components/layout/Footer.astro";
import SkipToContent from "../components/ui/SkipToContent.astro";
import HeaderScrollBehavior from "../components/layout/HeaderScrollBehavior.astro";
import { MobileNav } from "../components/layout/MobileNav";
import { ThemeCustomizer } from "../components/ui/ThemeCustomizer";
import SimpleAnalytics from "../components/analytics/SimpleAnalytics.astro";
import "../styles/global.css";

export interface Props {
  title: string;
  description?: string;
  includeSidebar?: boolean;
}

const {
  title,
  description = "VectorTA - High-performance technical analysis library with 300+ indicators",
  includeSidebar = true,
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title} | VectorTA</title>
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Theme color -->
    <meta name="theme-color" content="#3b82f6" />

    <!-- Critical theme script - must run before render to prevent flash -->
    <script is:inline>
      // This runs immediately to prevent theme flash
      (function () {
        // Migrate from old theme storage if needed
        const oldTheme = localStorage.getItem("theme");
        if (oldTheme && !localStorage.getItem("theme-preference")) {
          // User has old theme setting, migrate to new system
          localStorage.setItem("theme-preference", oldTheme);
          localStorage.removeItem("theme");
        }
        
        // Get theme preference (system/light/dark)
        const preference = localStorage.getItem("theme-preference") || "system";
        
        // Get actual theme to apply
        let theme;
        if (preference === "system") {
          // Use system preference
          theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
        } else {
          // Use explicit preference
          theme = preference;
        }
        
        // Apply theme
        document.documentElement.classList.add(theme);
        document.documentElement.setAttribute("data-theme-preference", preference);

        // Update theme color meta tag
        const themeColor = theme === "dark" ? "#171717" : "#3b82f6";
        const metaTheme = document.querySelector('meta[name="theme-color"]');
        if (metaTheme) metaTheme.setAttribute("content", themeColor);
      })();
    </script>

    <!-- Preload fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Service Worker Registration -->
    <script is:inline>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("/ta/sw.js").catch((err) => {
            console.log("ServiceWorker registration failed:", err);
          });
        });
      }
    </script>
    
    <!-- Analytics -->
    <SimpleAnalytics />
  </head>
  <body class="bg-background text-foreground min-h-screen flex flex-col">
    <SkipToContent />
    <Header />
    <HeaderScrollBehavior />

    <div class="flex-1 flex flex-col">
      {
        includeSidebar ? (
          <div class="flex flex-1">
            <Sidebar />
            <div class="flex-1 lg:ml-64 min-w-0 flex flex-col">
              <main id="main-content" class="flex-1" role="main">
                <div class="px-4 sm:px-6 py-6 sm:py-8">
                  <slot />
                </div>
              </main>
              <Footer />
            </div>
          </div>
        ) : (
          <>
            <main id="main-content" class="flex-1" role="main">
              <slot />
            </main>
            <Footer />
          </>
        )
      }
    </div>

    {/* Mobile Navigation - only show when sidebar is included */}
    {includeSidebar && <MobileNav client:load currentPath={Astro.url.pathname} />}

    {/* Theme Customizer */}
    <ThemeCustomizer client:idle position="right" />

    <script>
      // Apply theme based on preference
      const applyTheme = () => {
        const preference = localStorage.getItem("theme-preference") || "system";
        let theme;
        
        if (preference === "system") {
          // Use system preference
          theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
        } else {
          // Use explicit preference
          theme = preference;
        }
        
        // Update classes
        document.documentElement.classList.remove("light", "dark");
        document.documentElement.classList.add(theme);
        
        // Update theme color meta tag
        const themeColor = theme === "dark" ? "#171717" : "#3b82f6";
        const metaTheme = document.querySelector('meta[name="theme-color"]');
        if (metaTheme) metaTheme.setAttribute("content", themeColor);
        
        // Dispatch event for other components
        window.dispatchEvent(new CustomEvent("theme-applied", {
          detail: { theme, preference }
        }));
      };

      // Listen for preference changes
      window.addEventListener("theme-preference-change", (e) => {
        applyTheme();
      });
      
      // Listen for system theme changes when in system mode
      const systemThemeQuery = window.matchMedia("(prefers-color-scheme: dark)");
      systemThemeQuery.addEventListener("change", () => {
        const preference = localStorage.getItem("theme-preference") || "system";
        if (preference === "system") {
          applyTheme();
        }
      });
      
      // Legacy support: Listen for old theme-change events
      window.addEventListener("theme-change", (e) => {
        const newTheme = (e as CustomEvent).detail.theme;
        // Convert to new preference system
        localStorage.setItem("theme-preference", newTheme);
        localStorage.removeItem("theme"); // Clean up old storage
        applyTheme();
      });

    </script>
  </body>
</html>

