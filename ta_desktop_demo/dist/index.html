<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>VectorTA Optimizer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./app.css" />
  </head>
  <body>
    <header>
      <h1>VectorTA Optimizer (Double MA)</h1>
    </header>
    <main>
      <section class="card">
        <h2>Data</h2>
        <div>
          <label for="csvPath">CSV path (local file path)</label>
          <div class="rowAuto">
            <input id="csvPath" type="text" placeholder="C:\\path\\to\\candles.csv" list="csvRecentList" />
            <button id="btnBrowseCsv">Browse…</button>
          </div>
          <datalist id="csvRecentList"></datalist>
        </div>
        <div class="actions">
          <button class="primary" id="btnLoad">Load CSV</button>
          <button id="btnClear">Clear</button>
        </div>
        <div id="sampleCsvWrap" style="display: none; margin-top: 0.75rem;">
          <div class="muted" style="margin-bottom: 0.35rem; font-size: 0.8rem;">Sample datasets</div>
          <div class="actions" id="sampleCsvs" style="margin-top: 0;"></div>
        </div>
        <div class="row" style="margin-top: 0.65rem;">
          <div>
            <div class="muted">Loaded data id</div>
            <div class="mono" id="dataId">—</div>
          </div>
          <div>
            <div class="muted">Rows</div>
            <div class="mono" id="dataLen">—</div>
          </div>
        </div>
        <div style="margin-top: 0.55rem;">
          <div class="muted">Fields</div>
          <div class="badges" id="dataFields"></div>
          <div class="muted" id="dataFieldHint" style="margin-top: 0.35rem; font-size: 0.8rem;"></div>
        </div>

        <hr style="border: none; border-top: 1px solid var(--border); margin: 1.1rem 0 0.9rem;" />
        <h2>Optimization</h2>
        <div class="row">
          <div>
            <label for="backend">Backend</label>
            <select id="backend">
              <option value="Auto">Auto (best available)</option>
              <option value="CpuOnly">CPU</option>
              <option value="GpuOnly">GPU (MA sweep)</option>
              <option value="GpuKernel">GPU (kernel)</option>
            </select>
          </div>
          <div>
            <label for="deviceId">GPU device id</label>
            <input id="deviceId" type="number" min="0" step="1" value="0" />
          </div>
        </div>
        <div class="actions" style="margin-top: 0.65rem;">
          <button class="primary" id="btnPresetKernelSmaAlma">Preset: GPU kernel (SMA/ALMA)</button>
        </div>

        <div class="split" style="margin-top: 0.9rem;">
          <div>
            <div class="muted" style="margin-bottom: 0.35rem;">Fast range</div>
            <div class="row3">
              <div>
                <label for="fastStart">Start</label>
                <input id="fastStart" type="number" min="1" step="1" value="5" />
              </div>
              <div>
                <label for="fastEnd">End</label>
                <input id="fastEnd" type="number" min="1" step="1" value="30" />
              </div>
              <div>
                <label for="fastStep">Step</label>
                <input id="fastStep" type="number" min="0" step="1" value="1" />
              </div>
            </div>
            <div style="margin-top: 0.65rem;">
              <label for="fastMaType">Fast MA type</label>
              <select id="fastMaType"></select>
              <div class="muted" style="margin-top: 0.3rem; font-size: 0.8rem;">
                Tip: use GPU (kernel) for <span class="mono">sma/ema/wma/alma</span>.
              </div>
            </div>
          </div>

          <div>
            <div class="muted" style="margin-bottom: 0.35rem;">Slow range</div>
            <div class="row3">
              <div>
                <label for="slowStart">Start</label>
                <input id="slowStart" type="number" min="1" step="1" value="20" />
              </div>
              <div>
                <label for="slowEnd">End</label>
                <input id="slowEnd" type="number" min="1" step="1" value="120" />
              </div>
              <div>
                <label for="slowStep">Step</label>
                <input id="slowStep" type="number" min="0" step="1" value="1" />
              </div>
            </div>
            <div style="margin-top: 0.65rem;">
              <label for="slowMaType">Slow MA type</label>
              <select id="slowMaType"></select>
              <div class="muted" style="margin-top: 0.3rem; font-size: 0.8rem;">
                Tip: use GPU (MA sweep) to compare many MA types.
              </div>
            </div>
          </div>
        </div>

        <div class="split" style="margin-top: 0.9rem;">
          <div id="fastMaParamsWrap" style="display: none;">
            <div class="muted" style="margin-bottom: 0.35rem;">Fast MA parameters</div>
            <div id="fastMaParamsBody"></div>
          </div>
          <div id="slowMaParamsWrap" style="display: none;">
            <div class="muted" style="margin-bottom: 0.35rem;">Slow MA parameters</div>
            <div id="slowMaParamsBody"></div>
          </div>
        </div>

        <div class="row" style="margin-top: 0.9rem;">
          <div>
            <label for="maSource">MA price source</label>
            <select id="maSource">
              <option value="close" selected>close</option>
              <option value="open">open</option>
              <option value="high">high</option>
              <option value="low">low</option>
              <option value="hl2">hl2</option>
              <option value="hlc3">hlc3</option>
              <option value="hlcc">hlcc (hlcc4)</option>
              <option value="ohlc4">ohlc4</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top: 0.9rem;">
          <div>
            <label for="objective">Objective</label>
            <select id="objective">
              <option value="Sharpe">Sharpe</option>
              <option value="Pnl">PnL</option>
              <option value="MaxDrawdown">Min drawdown</option>
            </select>
          </div>
          <div>
            <label for="mode">Mode</label>
            <select id="mode">
              <option value="Grid">Grid</option>
              <option value="CoarseToFine">Coarse→Fine</option>
              <option value="Auto">Auto</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top: 0.9rem;">
          <div>
            <label for="heatmapBins">Heatmap bins (0 = off)</label>
            <input id="heatmapBins" type="number" min="0" step="1" value="128" />
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="muted" style="font-size: 0.8rem;">Binned best-score heatmap (objective).</div>
          </div>
        </div>

        <div class="row" style="margin-top: 0.9rem;">
          <div>
            <label for="topK">Return top K (0 = best only)</label>
            <input id="topK" type="number" min="0" step="1" value="20" />
          </div>
          <div>
            <label for="includeAll">Return all results (can be huge)</label>
            <select id="includeAll">
              <option value="false" selected>False</option>
              <option value="true">True</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top: 0.9rem;">
          <div>
            <label for="exportAllCsvPath">Export per-pair metrics CSV path (optional)</label>
            <div class="rowAuto">
              <input id="exportAllCsvPath" type="text" placeholder="C:\\path\\to\\all_pairs.csv" />
              <button id="btnBrowseExportAll">Browse…</button>
            </div>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="muted" style="font-size: 0.8rem;">
              GPU (kernel) only; requires "Return all results" = False. Writes one row per (fast, slow) pair.
            </div>
          </div>
        </div>

        <hr style="border: none; border-top: 1px solid var(--border); margin: 1.1rem 0 0.9rem;" />
        <h2>Strategy</h2>
        <div class="row3">
          <div>
            <label for="commission">Commission (fraction)</label>
            <input id="commission" type="number" min="0" step="0.0001" value="0" />
          </div>
          <div>
            <label for="epsRel">Epsilon band (eps_rel)</label>
            <input id="epsRel" type="number" min="0" step="0.0001" value="0" />
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="muted" style="font-size: 0.8rem;">Example: 0.001 = 0.1%</div>
          </div>
        </div>
        <div class="checks" style="margin-top: 0.55rem;">
          <label><input id="longOnly" type="checkbox" checked /> Long-only</label>
          <label><input id="allowFlip" type="checkbox" checked /> Allow flip</label>
          <label><input id="tradeOnNext" type="checkbox" checked /> Trade on next bar</label>
        </div>

        <div class="actions">
          <button class="primary" id="btnRun">Run optimization</button>
          <button class="danger-btn" id="btnCancel" disabled>Cancel</button>
        </div>
        <div class="muted" style="margin-top: 0.6rem; font-size: 0.8rem;">
          Tip: GPU (kernel) stays VRAM-resident and is best for large grids.
        </div>
      </section>

      <section class="card">
        <h2>Status</h2>
        <div class="mono" id="status">Ready.</div>
        <div id="progressWrap" style="display: none; margin-top: 0.65rem;">
          <div class="progress">
            <div class="progressFill" id="progressFill"></div>
          </div>
          <div class="muted" id="progressMeta" style="margin-top: 0.35rem; font-size: 0.8rem;"></div>
        </div>

        <div class="row" style="margin-top: 0.9rem;">
          <div>
            <label for="historySelect">Run history</label>
            <select id="historySelect"></select>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="actions" style="margin-top: 0;">
              <button id="btnApplyHistory">Apply to form</button>
              <button id="btnExportPreset">Export preset</button>
              <button id="btnImportPreset">Import preset</button>
              <button id="btnClearHistory">Clear history</button>
            </div>
          </div>
        </div>
        <input id="presetFile" type="file" accept=".json,application/json" style="display: none;" />

        <hr style="border: none; border-top: 1px solid var(--border); margin: 1.1rem 0 0.9rem;" />
        <h2>Compare</h2>
        <div class="row" style="margin-bottom: 0.75rem;">
          <div>
            <label for="compareSelect">Baseline run</label>
            <select id="compareSelect"></select>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="actions" style="margin-top: 0;">
              <button id="btnSetBaseline">Set baseline = current</button>
              <button id="btnClearBaseline">Clear baseline</button>
            </div>
          </div>
        </div>
        <div class="mono" id="compareSummary" style="white-space: pre-wrap;">-</div>

        <hr style="border: none; border-top: 1px solid var(--border); margin: 1.1rem 0 0.9rem;" />
        <h2>Best</h2>
        <div class="mono" id="bestSummary">-</div>

        <div class="actions" style="margin-top: 0.9rem;">
          <button id="btnExportCsv">Export top CSV</button>
          <button id="btnExportJson">Export JSON</button>
        </div>

        <hr style="border: none; border-top: 1px solid var(--border); margin: 1.1rem 0 0.9rem;" />
        <h2>Top</h2>
        <div class="row3" style="margin-bottom: 0.75rem;">
          <div>
            <label for="filterMinPnl">Min PnL</label>
            <input id="filterMinPnl" type="number" step="any" placeholder="(no filter)" />
          </div>
          <div>
            <label for="filterMinSharpe">Min Sharpe</label>
            <input id="filterMinSharpe" type="number" step="any" placeholder="(no filter)" />
          </div>
          <div>
            <label for="filterMaxDd">Max MaxDD</label>
            <input id="filterMaxDd" type="number" step="any" placeholder="(no filter)" />
          </div>
        </div>
        <div class="row3" style="margin-bottom: 0.75rem;">
          <div>
            <label for="filterMinTrades">Min trades</label>
            <input id="filterMinTrades" type="number" min="0" step="1" placeholder="(no filter)" />
          </div>
          <div>
            <label for="filterMinExposure">Min exposure</label>
            <input id="filterMinExposure" type="number" step="any" placeholder="(no filter)" />
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="actions" style="margin-top: 0;">
              <button id="btnClearTopFilters">Clear filters</button>
            </div>
          </div>
        </div>
        <div class="muted" style="margin: 0.25rem 0 0.6rem; font-size: 0.85rem;" id="topFilterMeta">-</div>
        <div class="table-wrap">
          <table id="topTable">
            <thead>
              <tr>
                <th data-key="rank" class="left">#</th>
                <th data-key="fast" class="left">Fast</th>
                <th data-key="slow" class="left">Slow</th>
                <th data-key="pnl">PnL</th>
                <th data-key="sharpe">Sharpe</th>
                <th data-key="max_dd">MaxDD</th>
                <th data-key="trades">Trades</th>
                <th data-key="exposure">Expo</th>
              </tr>
            </thead>
             <tbody id="topTableBody"></tbody>
           </table>
         </div>

        <div id="paretoWrap" style="margin-top: 1.1rem; display: none;">
          <h2>Pareto</h2>
          <div class="row" style="margin-bottom: 0.75rem;">
            <div>
              <label for="paretoX">X axis</label>
              <select id="paretoX">
                <option value="max_dd">MaxDD (lower better)</option>
                <option value="pnl">PnL (higher better)</option>
                <option value="sharpe">Sharpe (higher better)</option>
                <option value="trades">Trades (higher better)</option>
                <option value="exposure">Exposure (higher better)</option>
              </select>
            </div>
            <div>
              <label for="paretoY">Y axis</label>
              <select id="paretoY">
                <option value="pnl">PnL (higher better)</option>
                <option value="sharpe">Sharpe (higher better)</option>
                <option value="max_dd">MaxDD (lower better)</option>
                <option value="trades">Trades (higher better)</option>
                <option value="exposure">Exposure (higher better)</option>
              </select>
            </div>
          </div>
          <div class="muted" style="margin: 0.25rem 0 0.6rem; font-size: 0.85rem;" id="paretoMeta">-</div>
          <canvas id="paretoCanvas" class="chart" width="1024" height="240"></canvas>
          <div class="muted" style="margin-top: 0.5rem; font-size: 0.8rem;">
            Click a point to drill down that parameter pair.
          </div>
        </div>

        <div id="drillWrap" style="margin-top: 1.1rem; display: none;">
          <h2>Drilldown</h2>
          <div class="muted" style="margin-bottom: 0.5rem; font-size: 0.8rem;" id="drillMeta">-</div>
          <div class="muted" style="margin-bottom: 0.5rem; font-size: 0.8rem;" id="drillStatus">Click a Top row to view curves.</div>
          <div>
            <div class="muted" style="margin-bottom: 0.35rem; font-size: 0.8rem;">Equity (min/max per bin)</div>
            <canvas id="equityCanvas" class="chart" width="1024" height="160"></canvas>
          </div>
          <div style="margin-top: 0.75rem;">
            <div class="muted" style="margin-bottom: 0.35rem; font-size: 0.8rem;">Drawdown (min/max per bin)</div>
            <canvas id="drawdownCanvas" class="chart" width="1024" height="160"></canvas>
          </div>

          <div id="tradeStatsWrap" style="margin-top: 1.1rem; display: none;">
            <h2>Trades</h2>
            <div class="mono" id="tradeStats">-</div>
            <div class="table-wrap" style="margin-top: 0.6rem;">
              <table id="tradeTable">
                <thead>
                  <tr>
                    <th class="left">#</th>
                    <th class="left">Dir</th>
                    <th class="left">Entry</th>
                    <th class="left">Exit</th>
                    <th>Bars</th>
                    <th>PnL</th>
                    <th class="left">State</th>
                  </tr>
                </thead>
                <tbody id="tradeTableBody"></tbody>
              </table>
            </div>
            <div class="muted" style="margin-top: 0.5rem; font-size: 0.8rem;">
              Showing last 200 trades (if available).
            </div>
          </div>
        </div>

        <div id="heatmapWrap" style="margin-top: 1.1rem; display: none;">
          <h2>Heatmap</h2>
          <div class="muted" style="margin-bottom: 0.5rem; font-size: 0.8rem;" id="heatmapMeta">-</div>
          <canvas id="heatmapCanvas" width="512" height="512"></canvas>
        </div>

        <details style="margin-top: 1.1rem;">
          <summary class="muted">Debug JSON</summary>
          <pre class="mono" id="output">{}</pre>
        </details>
      </section>
    </main>

    <script type="module" src="./app.js"></script>
  </body>
  </html>

